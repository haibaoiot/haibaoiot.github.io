---
layout: docwithnav
assignees:
- ashvayka
title: Rule Engine
description: IoT devices data analytics using Thingsboard Rule engine

---

* TOC
{:toc}

    规则引擎允许您处理具有可配置规则集的设备的消息。
使用规则引擎可以：

- 设备属性更改时发送电子邮件。
- 当遥测值超过一定阈值时，会产生报警。
- 将遥测数据转发到Kafka，RabbitMQ或外部RESTful服务器。
- 更多使用其他规则和插件。
- 
**注意**  我们建议在继续操作之前熟悉基本的物联网功能 - （ 属性， 遥测和 RPC）。

规则引擎运行两个主要组件：规则和插件。规则引擎的工作是将配置的规则顺序应用于传入的消息。虽然顺序应用规则，但规则执行是异步的，并且基于actors。这允许以与它们相同的顺序处理来自设备的消息而不牺牲性能。

处理结果可能也可能不会传回设备应用程序。这取决于规则配置。例如，您可以将传入的遥测数据推送到Cassandra DB内部，同时将其发送到Kafka。您可以配置为忽略Kafka错误或将错误报告回设备。在这种情况下，设备可以重试操作，将数据重新发送到不同的服务器，或者简单地忽略该错误。

 ![image](/images/rule-engine.svg)

##规则与插件

我们将回顾下面的例子来解释Rule和Plugin之间的区别。假设当发动机温度过高时，您想要向工程师发送电子邮件。在这种情况下，规则负责分析遥测数据和建立电子邮件（身体，到，cc等）。但是，插件负责与电子邮件服务器的实际通信并发送电子邮件。因此，多个规则可以使用一次配置的相同的电子邮件插件。
##范围

规则和插件可能在系统和租户层面上运行。
系统级规则和插件由系统管理员管理。他们处理所有设备的消息。
租户层级规则和插件由相应的租户管理员管理。他们处理属于特定租户的设备的消息。租户级规则能够定位系统级插件。例如，您可以配置在系统级发送通知的插件。您需要在插件配置中指定您的电子邮件帐户。但是，所有租户级别的规则可能会使用此插件来发送电子邮件通知。
##生命周期

事件板规则和插件组件具有相同的生命周期事件：
已创建 - 组件已配置，但尚未处理任何消息。
激活的组件能够接收和处理新的设备消息。
已暂停 - 组件无法接收新的设备消息。
已删除 - 组件已停止并从数据库中删除。
##规则

事件板规则由三个主要组件组成：过滤器，处理器和操作。根据实现情况，每个组件可能需要某些配置才能使用。为了配置规则，您需要至少指定一个过滤器和一个操作。规则处理器是可选的。
我们来回顾各个组件的角色。
#####过滤器

规则过滤器负责过滤传入消息。您可以将其视为具有设备属性和消息作为参数的布尔函数：
   boolean filter(DeviceAttributes attributes, FromDeviceMessage message) 
事件板提供以下规则过滤器开箱即用：
消息类型过滤器 - 允许按类型过滤传入消息。
设备属性过滤器 - 允许基于当前设备属性过滤传入的消息。您可以使用javascript定义过滤器。有关详细信息，请参阅过滤器文档。
设备遥测滤波器 - 允许基于其值来过滤传入的“后期遥测”消息。您可以使用javascript定义过滤器。有关详细信息，请参阅过滤器文档。
方法名称过滤器 - 允许根据其方法名称过滤传入的“RPC请求”消息。
单一规则可能包含多个过滤器。通常可以首先基于消息类型和设备属性过滤，然后根据消息的内容应用附加过滤。
#####处理器

规则处理器负责处理传入的消息并向其添加元数据。您可以将其视为具有设备属性和消息作为参数并返回某些元数据的函数：
   MessageMetadata process(DeviceAttributes attributes, FromDeviceMessage message) 
事件板提供了以下规则处理器开箱即用：
报警重复数据删除处理器生成并保持唯一的报警。填充某些元数据标签以识别新的警报。有关详细信息，请参阅过滤器文档。
#####行动

插件操作负责将传入的消息和元数据转换为转发到某个插件的新的自定义消息。行动可能是单向或双向的。如果是单向行动，规则是不期待插件的回复。在的情况下，双向作用，规则期待从某些超时插件答复。如果在配置的超时内没有回复，规则将向设备报告错误。
例如，将数据存储到内部存储是双向动作，但是，推到数据的外部系统可以是单向（可选）。
虽然特定Action是相应规则的一部分，您也可以将其视为相应插件的一部分。因此，您可以将操作视为Rule和Plugin之间的以下界面：
   RuleToPluginMessage<T> convert(DeviceAttributes attributes, FromDeviceMessage message, MessageMetadata metadata)
   
   ToDeviceMsg convert(PluginToRuleMsg<T> message)
   
   boolean isOneWay()
Thingsboard提供了开箱即用的操作：
遥测插件动作 - 将数据推送到系统遥测插件的系统动作。
发送邮件操作 - 允许发送电子邮件的操作。您可以为电子邮件正文和收件人指定模板。在模板评估过程中，您可以从传入的消息中替换设备属性和数据。有关详细信息，请参阅操作文档。
Kafka插件动作 - 允许将消息推送到卡夫卡主题的操作。您可以为邮件正文指定模板。在模板评估过程中，您可以从传入的消息中替换设备属性和数据。有关详细信息，请参阅操作文档。
RabbitMQ插件动作 - 类似于Kafka动作，但将数据推送到RabbitMQ。
REST API调用插件操作 - 类似于Kafka操作，但执行REST API调用。
RPC插件操作 - 将设备RPC调用转发到相应的插件。
##插件

Thingsboard插件允许您配置和自定义系统行为。虽然插件能够处理来自规则的消息，但是它们还提供了与服务器端应用程序集成的API。使用插件，您可以：
从设备处理消息
从服务器端应用程序处理REST API调用
使用websockets与服务器端应用程序通信。
使用异步RPC调用在Thingsboard集群中的同一个插件的实例之间进行通信。
持续和查询事件，遥测数据和设备属性。
图片
正如我们已经讨论过的，规则可以使用动作与插件通信。我们来看看其他Plugin API。
#####REST API

插件能够处理来自授权用户（客户和系统或租户管理员）的REST API调用。这可能对于服务器端集成很有用。例如，System RPC Plugin允许使用REST API对设备执行RPC调用。
#####Websocket API

插件能够处理来自授权用户（客户和系统或租户管理员）的websocket消息。这可能对于想要接收实时更新的服务器端应用程序的集成很有用。例如，System Telemetry Plugin允许使用websockets订阅设备属性和时间序列数据更改。
#####聚类API

当插件被配置时，Thingsboard在集群中的每个Thingsboard服务器上创建一个插件演员的实例。为了实现复杂的用例，插件实例可能需要一种彼此通信的方式。
例如，假设我们有一个三节点集群（节点A，B和C）。设备可以通过MQTT会话连接到节点A.客户用户可以打开Web UI来实时观察遥测数据，并且负载平衡器将将浏览器转发到不同的节点（在我们的例子中为B和C）。遥测插件需要跟踪特定设备的websocket订阅，以便将更新推送到客户的浏览器。
图片
事件板集群和演员模型涵盖在Thingsboard Architecture中。
事件板架构
#####实施

事件板提供了以下插件开箱即用：
遥测插件 - 负责处理与设备属性和遥测相关的各种请求的系统插件。
RPC插件 - 允许使用REST API对设备执行RPC调用。RPC呼叫将使用支持的网络协议传送到设备。
设备消息插件 - 允许分配给同一客户的设备交换事件。
发送邮件插件 - 允许发送电子邮件。您可以指定邮件服务器属性。有关更多详细信息，请参阅插件文档。
Kafka插件 - 允许将遥测信息推送到Apache Kafka。有关更多详细信息，请参阅插件文档。
RabbitMQ插件 - 允许将遥测信息推送到RabbitMQ。有关更多详细信息，请参阅插件文档。
REST API调用插件 - 允许使用REST API将遥测消息推送到外部服务器。有关更多详细信息，请参阅插件文档。
时间RPC插件 - 允许从设备发送RPC请求以获取当前的服务器端时间戳。
##故障排除和统计

Thingsboard跟踪每个规则和插件的使用情况统计信息，错误和生命周期事件。
#####统计

Thingsboard收集并定期将使用统计信息保存到内部数据库。您可以通过Web UI查看此统计信息，或使用REST API查看。统计数据包含成功处理的邮件数量和处理过程中的错误数量。
#####错误

每当出现异常或错误时，Thingsboard将其保留到内部数据库。您可以通过Web UI查看此错误或使用REST API获取错误。如果插件配置错误或关键问题，错误可能会频繁出现。保持所有错误可能会显着降低性能，因此您可以配置错误持续存在的频率。
#####生命周期事件

当插件或规则生命周期事件发生时，Thingsboard将其保留到内部数据库。您可以观察生命周期的状态，发生错误时的堆栈跟踪，事件时间和服务器地址。在错误配置的情况下，您可以通过浏览错误堆栈跟踪轻松检测根本原因。